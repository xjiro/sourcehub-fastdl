<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>SourceHub FastDL</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://sourcehub.lol/static/darkly.css" rel="stylesheet">
    <link href="https://sourcehub.lol/static/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@4.0.0/dist/jquery.min.js"></script>

    <style>
        body {
            padding: 2rem;
            font-family: "Space Mono", monospace;
        }

        .folder {
            font-weight: bold;
            cursor: pointer;
        }

        .file {
            margin-left: 1rem;
        }

        .folder::before {
            content: "üìÅ ";
        }

        .file::before {
            content: "üìÑ ";
        }

        .highlight {
            background: #ffd666;
            color: #111;
            border-radius: 4px;
            padding: 0 4px;
        }
    </style>
</head>

<body>
    <div class="row g-3">
        <div class="col-md-3 d-none d-md-block text-end">
            <img style="width:100px;height:87px;" class="mb-2" src="https://sourcehub.lol/static/icon.svg">
            <h3 class="mb-4">SourceHub FastDL</h3>
        </div>
        <div class="col-sm-12 d-md-none">
            <img style="width:50px;height:44px;" class="mb-2" src="https://sourcehub.lol/static/icon.svg">
            <h3 class="mb-2">SourceHub FastDL</h3>
        </div>
        <div class="col-md-9 col-sm-12">
            <div class="mb-3">
                <input id="search" type="search" class="form-control mb-2" style="max-width: 360px;" placeholder="Search files or folders">
                <button id="expand-all" class="btn btn-outline-light btn-sm mb-2">Expand all</button>
                <button id="collapse-all" class="btn btn-outline-light btn-sm mb-2">Collapse all</button>
            </div>
            <div id="file-tree"></div>
        </div>
    </div>

    <script>
        function buildTree(paths) {
            const root = {};

            paths.forEach(path => {
                const parts = path.split("/");
                let current = root;

                parts.forEach((part, idx) => {
                    if (!current[part]) {
                        current[part] = (idx === parts.length - 1) ? null : {};
                    }
                    current = current[part];
                });
            });

            return root;
        }

        function renderTree(node, container, prefix = "") {
            const keys = Object.keys(node).sort((a, b) => {
                const aIsDir = node[a] !== null;
                const bIsDir = node[b] !== null;

                if (aIsDir !== bIsDir) {
                    return aIsDir ? -1 : 1;
                }

                return a.localeCompare(b, undefined, { sensitivity: "base" });
            });

            keys.forEach(key => {
                const value = node[key];
                const fullPath = prefix ? prefix + "/" + key : key;

                if (value === null) {
                    container.append(
                        `<div class="file" data-path="${fullPath}"><a href="${fullPath}" target="_blank">${key}</a></div>`
                    );
                } else {
                    const folder = $(`<div class="folder" data-path="${fullPath}">${key}/</div>`);
                    const children = $('<div class="children ms-4" style="display:none;"></div>');
                    folder.on("click", () => children.toggle());
                    container.append(folder);
                    container.append(children);
                    renderTree(value, children, fullPath);
                }
            });
        }

        function setAllFolders(expand) {
            $(".children").toggle(expand);
        }

        function clearHighlights() {
            $(".highlight").removeClass("highlight");
        }

        let lastQuery = "";

        function runSearch(query, didChange) {
            clearHighlights();

            if (didChange) {
                setAllFolders(false);
            }

            if (!query) {
                return;
            }

            const term = query.toLowerCase();

            $(".file").each(function () {
                const path = $(this).data("path").toString().toLowerCase();
                if (path.includes(term)) {
                    $(this).addClass("highlight");
                    $(this).parents(".children").show();
                }
            });

            $(".folder").each(function () {
                const path = $(this).data("path").toString().toLowerCase();
                if (path.includes(term)) {
                    $(this).addClass("highlight");
                    $(this).next(".children").show();
                    $(this).parents(".children").show();
                }
            });
        }

        $.getJSON("file_index.json", function (data) {
            const tree = buildTree(data);
            renderTree(tree, $("#file-tree"));
        });

        $("#expand-all").on("click", () => setAllFolders(true));
        $("#collapse-all").on("click", () => setAllFolders(false));
        $("#search").on("input", function () {
            const currentQuery = $(this).val().toString().trim();
            const didChange = currentQuery !== lastQuery;
            lastQuery = currentQuery;
            runSearch(currentQuery, didChange);
        });
    </script>

    <footer class="mt-4">
        a part of <a href="https://sourcehub.lol">SourceHub</a>, made by <a href="https://xji.ro/steam">xjiro</a>
    </footer>

</body>

</html>